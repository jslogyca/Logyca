<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Template del formulario web para solicitud de producto -->
    <template id="product_request_form_template" name="Solicitud de Creación de Producto">
        <t t-call="website.layout">
            <div id="wrap" class="oe_structure oe_empty">
                <section class="s_cover pt96 pb96 o_colored_level">
                    <div class="o_we_bg_filter bg-black-50"></div>
                    <div class="container">
                        <div class="row">
                            <div class="col-lg-10 offset-lg-1">
                                <div class="card shadow-lg">
                                    <div class="card-header bg-success text-white">
                                        <h2 class="mb-0">
                                            <i class="fa fa-box mr-2"></i>
                                            Solicitud de Creación de Producto
                                        </h2>
                                    </div>
                                    <div class="card-body">
                                        <!-- Mensajes -->
                                        <t t-if="success">
                                            <div class="alert alert-success alert-dismissible fade show">
                                                <strong><i class="fa fa-check-circle"></i> ¡Solicitud Procesada Exitosamente!</strong>
                                                <p class="mb-0">Su solicitud ha sido enviada correctamente y está siendo procesada.</p>
                                                <t t-if="request_number">
                                                    <p class="mb-0 mt-2">
                                                        <strong>Número de Solicitud:</strong>
                                                        <span class="badge badge-success" t-esc="request_number"/>
                                                    </p>
                                                    <p class="mb-0 mt-2">
                                                        <small>Recibirá un correo electrónico con la confirmación y el número de solicitud.</small>
                                                    </p>
                                                </t>
                                                <button type="button" class="close" data-dismiss="alert">
                                                    <span>×</span>
                                                </button>
                                            </div>
                                        </t>

                                        <t t-if="error">
                                            <div class="alert alert-danger alert-dismissible fade show">
                                                <strong><i class="fa fa-exclamation-triangle"></i> Error:</strong>
                                                <span t-esc="error"/>
                                                <button type="button" class="close" data-dismiss="alert">
                                                    <span>×</span>
                                                </button>
                                            </div>
                                        </t>

                                        <!-- Formulario -->
                                        <form id="product_request_form" action="/producto/submit" method="post" enctype="multipart/form-data">
                                            
                                            <!-- Información del Solicitante -->
                                            <h4 class="text-primary mt-3 mb-3">
                                                <i class="fa fa-user"></i> Información del Solicitante
                                            </h4>
                                            <hr/>
                                            
                                            <div class="row">
                                                <div class="col-md-6 form-group">
                                                    <label for="partner_id">
                                                        <strong>Nombre del Colaborador (Solicitante)</strong>
                                                        <span class="text-danger">*</span>
                                                    </label>
                                                    <select name="partner_id" id="partner_id" class="form-control" required="required">
                                                        <option value="">-- Seleccione --</option>
                                                        <t t-foreach="partners" t-as="partner">
                                                            <option t-att-value="partner.id" t-esc="partner.name"/>
                                                        </t>
                                                    </select>
                                                </div>

                                                <div class="col-md-6 form-group">
                                                    <label for="company_id">
                                                        <strong>Organización</strong>
                                                        <span class="text-danger">*</span>
                                                    </label>
                                                    <select name="company_id" id="company_id" class="form-control" required="required">
                                                        <option value="">-- Seleccione --</option>
                                                        <t t-foreach="companies" t-as="company">
                                                            <option t-att-value="company.id" 
                                                                    t-att-selected="'selected' if company.id == request.env.company.id else None"
                                                                    t-esc="company.name"/>
                                                        </t>
                                                    </select>
                                                    <small class="form-text text-muted">Organización para la cual se va crear el Producto</small>
                                                </div>
                                            </div>

                                            <!-- Información del Producto -->
                                            <h4 class="text-primary mt-4 mb-3">
                                                <i class="fa fa-box"></i> Información del Producto
                                            </h4>
                                            <hr/>

                                            <div class="row">
                                                <div class="col-md-6 form-group">
                                                    <label for="product_type">
                                                        <strong>Producto en Odoo</strong>
                                                        <span class="text-danger">*</span>
                                                    </label>
                                                    <select name="product_type" id="product_type" class="form-control" required="required">
                                                        <option value="">-- Seleccione --</option>
                                                        <option value="existing">Existente (Producto ya Creado en Odoo)</option>
                                                        <option value="new">Nuevo (Que no está en el portafolio actualmente)</option>
                                                        <option value="variants">Variantes (Forma de venta/Paquete-Referencia-Tiempo-Alcance del servicio-Promociones)</option>
                                                    </select>
                                                </div>

                                                <div class="col-md-6 form-group">
                                                    <label for="product_name">
                                                        <strong>Nombre del Producto</strong>
                                                        <span class="text-danger">*</span>
                                                    </label>
                                                    <input type="text" name="product_name" id="product_name" 
                                                           class="form-control" required="required" 
                                                           placeholder="Ingrese el nombre del producto"/>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-12 form-group">
                                                    <label for="product_justification">
                                                        <strong>Justificación del Producto</strong>
                                                        <span class="text-danger">*</span>
                                                    </label>
                                                    <textarea name="product_justification" id="product_justification" 
                                                              class="form-control" rows="3" required="required"
                                                              placeholder="Describa la justificación del producto"></textarea>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6 form-group">
                                                    <label for="disclosure_medium">
                                                        <strong>Medio de Divulgación del Producto</strong>
                                                        <span class="text-danger">*</span>
                                                    </label>
                                                    <select name="disclosure_medium" id="disclosure_medium" class="form-control" required="required">
                                                        <option value="">-- Seleccione --</option>
                                                        <option value="virtual_store">Tienda Virtual</option>
                                                        <option value="direct_negotiation">Negociación Directa</option>
                                                    </select>
                                                </div>

                                                <div class="col-md-6 form-group">
                                                    <label for="has_variants">
                                                        <strong>¿Tiene Variantes?</strong>
                                                        <span class="text-danger">*</span>
                                                    </label>
                                                    <select name="has_variants" id="has_variants" class="form-control" required="required">
                                                        <option value="">-- Seleccione --</option>
                                                        <option value="yes">Sí</option>
                                                        <option value="no">No</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div class="row" id="variants_file_row" style="display:none;">
                                                <div class="col-md-12 form-group">
                                                    <label for="variants_file">
                                                        <strong>Adjuntar Archivo de Variantes</strong>
                                                    </label>
                                                    <input type="file" name="variants_file" id="variants_file" 
                                                           class="form-control-file" 
                                                           accept=".pdf,.doc,.docx,.xls,.xlsx"/>
                                                    <small class="form-text text-muted">
                                                        Adjuntar archivo identificando y explicando cada variante
                                                    </small>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6 form-group">
                                                    <label for="analytic_account_id">
                                                        <strong>Cuenta Analítica del Producto</strong>
                                                        <span class="text-danger">*</span>
                                                    </label>
                                                    <select name="analytic_account_id" id="analytic_account_id" class="form-control" required="required">
                                                        <option value="">-- Primero seleccione Organización --</option>
                                                    </select>
                                                </div>

                                                <div class="col-md-6 form-group">
                                                    <label for="payment_method">
                                                        <strong>Forma de Pago</strong>
                                                        <span class="text-danger">*</span>
                                                    </label>
                                                    <select name="payment_method" id="payment_method" class="form-control" required="required">
                                                        <option value="">-- Seleccione --</option>
                                                        <option value="advance">Anticipado</option>
                                                        <option value="credit">A crédito</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6 form-group">
                                                    <label for="is_deferred">
                                                        <strong>¿Producto es Diferido?</strong>
                                                    </label>
                                                    <div class="form-check">
                                                        <input type="checkbox" name="is_deferred" id="is_deferred" 
                                                               class="form-check-input" value="true"/>
                                                        <label class="form-check-label" for="is_deferred">
                                                            Sí, el producto es diferido
                                                        </label>
                                                    </div>
                                                </div>

                                                <div class="col-md-6 form-group" id="deferred_time_group" style="display:none;">
                                                    <label for="deferred_time">
                                                        <strong>¿A Cuánto Tiempo se Difiere?</strong>
                                                    </label>
                                                    <input type="number" name="deferred_time" id="deferred_time" 
                                                           class="form-control" min="0"
                                                           placeholder="Tiempo en meses"/>
                                                    <small class="form-text text-muted">Tiempo en meses</small>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-12 form-group">
                                                    <label for="policy_responsible">
                                                        <strong>Responsable de las Políticas del Producto</strong>
                                                        <span class="text-danger">*</span>
                                                    </label>
                                                    <input type="text" name="policy_responsible" id="policy_responsible" 
                                                           class="form-control" required="required" 
                                                           placeholder="Nombre del responsable"/>
                                                </div>
                                            </div>

                                            <!-- ASPECTOS LEGALES -->
                                            <h4 class="text-primary mt-4 mb-3">
                                                <i class="fa fa-gavel"></i> ASPECTOS LEGALES A TENER EN CUENTA PARA LA CREACIÓN DEL PRODUCTO
                                            </h4>
                                            <hr/>

                                            <div class="row">
                                                <div class="col-md-12 form-group">
                                                    <label for="legal_purpose">
                                                        <strong>Objeto</strong>
                                                    </label>
                                                    <textarea name="legal_purpose" id="legal_purpose" 
                                                              class="form-control" rows="3"
                                                              placeholder="El propósito del contrato descrito de forma precisa. Permite definir la naturaleza jurídica de la relación que surge entre las partes"></textarea>
                                                    <small class="form-text text-muted">
                                                        El propósito del contrato descrito de forma precisa
                                                    </small>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-12 form-group">
                                                    <label for="specific_objectives">
                                                        <strong>Objetivos Específicos</strong>
                                                    </label>
                                                    <textarea name="specific_objectives" id="specific_objectives" 
                                                              class="form-control" rows="3"
                                                              placeholder="Relación detallada de los diversos propósitos que se pretenden con el contrato"></textarea>
                                                    <small class="form-text text-muted">
                                                        Si los hubiere, es una relación detallada de los diversos propósitos que se pretenden con el contrato
                                                    </small>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6 form-group">
                                                    <label for="scope">
                                                        <strong>Alcance</strong>
                                                    </label>
                                                    <textarea name="scope" id="scope" 
                                                              class="form-control" rows="3"
                                                              placeholder="Describa el alcance"></textarea>
                                                </div>

                                                <div class="col-md-6 form-group">
                                                    <label for="duration">
                                                        <strong>Duración</strong>
                                                    </label>
                                                    <textarea name="duration" id="duration" 
                                                              class="form-control" rows="3"
                                                              placeholder="Tiempo que las partes determinan para su ejecución"></textarea>
                                                    <small class="form-text text-muted">
                                                        Tiempo que las partes determinan para su ejecución e indicación de la posibilidad de prórroga
                                                    </small>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6 form-group">
                                                    <label for="place">
                                                        <strong>Lugar</strong>
                                                    </label>
                                                    <textarea name="place" id="place" 
                                                              class="form-control" rows="3"
                                                              placeholder="Lugar donde se ejecutará el contrato"></textarea>
                                                    <small class="form-text text-muted">
                                                        Lugar o lugares donde se ejecutará el contrato o se prestarán los servicios
                                                    </small>
                                                </div>

                                                <div class="col-md-6 form-group">
                                                    <label for="price">
                                                        <strong>Precio</strong>
                                                    </label>
                                                    <textarea name="price" id="price" 
                                                              class="form-control" rows="3"
                                                              placeholder="Determinación del monto del contrato"></textarea>
                                                    <small class="form-text text-muted">
                                                        Determinación del monto o la forma de su determinación, expresado en moneda colombiana o extranjera
                                                    </small>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-12 form-group">
                                                    <label for="logyca_obligations">
                                                        <strong>Obligaciones LOGYCA</strong>
                                                    </label>
                                                    <textarea name="logyca_obligations" id="logyca_obligations" 
                                                              class="form-control" rows="3"
                                                              placeholder="Relación de todas las obligaciones que surgen para LOGYCA"></textarea>
                                                    <small class="form-text text-muted">
                                                        Relación de todas las obligaciones que surgen para LOGYCA de la celebración del contrato o convenio (De dar, hacer o no hacer)
                                                    </small>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-12 form-group">
                                                    <label for="acceptor_obligations">
                                                        <strong>Obligaciones del Aceptante</strong>
                                                    </label>
                                                    <textarea name="acceptor_obligations" id="acceptor_obligations" 
                                                              class="form-control" rows="3"
                                                              placeholder="Especificar a qué se compromete el aceptante"></textarea>
                                                    <small class="form-text text-muted">
                                                        Especificar a qué se compromete el aceptante
                                                    </small>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-12 form-group">
                                                    <label for="termination_causes">
                                                        <strong>Causales Especiales de Terminación</strong>
                                                    </label>
                                                    <textarea name="termination_causes" id="termination_causes" 
                                                              class="form-control" rows="3"
                                                              placeholder="Condiciones o circunstancias especiales para la terminación anticipada"></textarea>
                                                    <small class="form-text text-muted">
                                                        Condiciones o circunstancias especiales que dieren lugar a la terminación del contrato de forma anticipada
                                                    </small>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-12 form-group">
                                                    <label for="liquidation_method">
                                                        <strong>Forma de Liquidación</strong>
                                                    </label>
                                                    <textarea name="liquidation_method" id="liquidation_method" 
                                                              class="form-control" rows="3"
                                                              placeholder="Forma de liquidación en caso de terminación anticipada"></textarea>
                                                    <small class="form-text text-muted">
                                                        En el evento de una terminación anticipada del contrato, describa la forma de prestación y reconocimiento
                                                    </small>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6 form-group">
                                                    <label for="contract_assignment">
                                                        <strong>Cesión del Contrato</strong>
                                                    </label>
                                                    <textarea name="contract_assignment" id="contract_assignment" 
                                                              class="form-control" rows="3"
                                                              placeholder="Indicar si hay posibilidad de cesión del contrato"></textarea>
                                                    <small class="form-text text-muted">
                                                        Indicar si hay posibilidad de cesión del contrato y si se requiere autorización previa
                                                    </small>
                                                </div>

                                                <div class="col-md-6 form-group">
                                                    <label for="penalty_clause">
                                                        <strong>Condiciones de Cláusula Penal</strong>
                                                    </label>
                                                    <textarea name="penalty_clause" id="penalty_clause" 
                                                              class="form-control" rows="3"
                                                              placeholder="Especificar las condiciones de cláusula penal"></textarea>
                                                    <small class="form-text text-muted">
                                                        Por favor especificar las condiciones, en caso de requerir cláusula penal
                                                    </small>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-12 form-group">
                                                    <label for="observations">
                                                        <strong>Observaciones</strong>
                                                    </label>
                                                    <textarea name="observations" id="observations" 
                                                              class="form-control" rows="3"
                                                              placeholder="Observaciones adicionales"></textarea>
                                                </div>
                                            </div>

                                            <div class="form-group text-center mt-4">
                                                <button type="submit" class="btn btn-success btn-lg">
                                                    <i class="fa fa-paper-plane"></i> Enviar Solicitud
                                                </button>
                                                <button type="reset" class="btn btn-secondary btn-lg ml-2">
                                                    <i class="fa fa-undo"></i> Limpiar
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
            
            <!-- JavaScript -->
            <script type="text/javascript">
            <![CDATA[
                document.addEventListener('DOMContentLoaded', function() {
                    // Cargar cuentas analíticas cuando cambia la compañía
                    var companySelect = document.getElementById('company_id');
                    var analyticAccountSelect = document.getElementById('analytic_account_id');
                    
                    companySelect.addEventListener('change', function() {
                        var companyId = this.value;
                        
                        // Limpiar opciones actuales
                        analyticAccountSelect.innerHTML = '<option value="">-- Cargando... --</option>';
                        
                        if (companyId) {
                            // Llamar al endpoint usando XMLHttpRequest
                            var xhr = new XMLHttpRequest();
                            xhr.open('POST', '/producto/get_analytic_accounts', true);
                            xhr.setRequestHeader('Content-Type', 'application/json');
                            
                            xhr.onload = function() {
                                if (xhr.status === 200) {
                                    try {
                                        var data = JSON.parse(xhr.responseText);
                                        analyticAccountSelect.innerHTML = '<option value="">-- Seleccione --</option>';
                                        
                                        if (data.result && data.result.accounts && data.result.accounts.length > 0) {
                                            data.result.accounts.forEach(function(account) {
                                                var option = document.createElement('option');
                                                option.value = account.id;
                                                option.textContent = account.name;
                                                analyticAccountSelect.appendChild(option);
                                            });
                                        } else {
                                            analyticAccountSelect.innerHTML = '<option value="">-- No hay cuentas analíticas --</option>';
                                        }
                                    } catch (e) {
                                        console.error('Error parsing JSON:', e);
                                        analyticAccountSelect.innerHTML = '<option value="">-- Error al cargar --</option>';
                                    }
                                } else {
                                    console.error('Error HTTP:', xhr.status);
                                    analyticAccountSelect.innerHTML = '<option value="">-- Error al cargar --</option>';
                                }
                            };
                            
                            xhr.onerror = function() {
                                console.error('Error de conexión');
                                analyticAccountSelect.innerHTML = '<option value="">-- Error al cargar --</option>';
                            };
                            
                            xhr.send(JSON.stringify({
                                jsonrpc: '2.0',
                                method: 'call',
                                params: {
                                    company_id: parseInt(companyId)
                                },
                                id: new Date().getTime()
                            }));
                        } else {
                            analyticAccountSelect.innerHTML = '<option value="">-- Primero seleccione Organización --</option>';
                        }
                    });
                    
                    // Mostrar/ocultar campo de archivo de variantes
                    var hasVariantsSelect = document.getElementById('has_variants');
                    var variantsFileRow = document.getElementById('variants_file_row');
                    
                    hasVariantsSelect.addEventListener('change', function() {
                        if (this.value === 'yes') {
                            variantsFileRow.style.display = 'block';
                        } else {
                            variantsFileRow.style.display = 'none';
                        }
                    });
                    
                    // Mostrar/ocultar campo de tiempo diferido
                    var isDeferredCheckbox = document.getElementById('is_deferred');
                    var deferredTimeGroup = document.getElementById('deferred_time_group');
                    
                    isDeferredCheckbox.addEventListener('change', function() {
                        if (this.checked) {
                            deferredTimeGroup.style.display = 'block';
                        } else {
                            deferredTimeGroup.style.display = 'none';
                            document.getElementById('deferred_time').value = '';
                        }
                    });
                });
            ]]>
            </script>
        </t>
    </template>
</odoo>
